const { spawn } = require('child_process');
const pythonDir = ("/Users/tommy/Documents/tommy/ewod_ship/server/api/cad/"); // Path of python script folder
//const python = pythonDir + "pythonEnv/bin/python"; // Path of the Python interpreter

function cleanWarning(error) {
    return error.replace(/Detector is not able to detect the language reliably.\n/g, "");
}

function callPython(scriptName, args) {
    return new Promise(function(success, reject) {
        const script = pythonDir + scriptName;
        const pyArgs = [script, args]; //JSON.stringify(args)]
        const pyprog = spawn('python3', pyArgs);
        let result = "";
        let resultError = "";
        pyprog.stdout.on('data', function(data) {
            result += data.toString();
        });

        pyprog.stderr.on('data', (data) => {
            resultError += cleanWarning(data.toString());
        });

        pyprog.stdout.on("end", function() {
            if (resultError == "") {
                success(result); //JSON.parse(result));
            } else {
                //console.error(`Python error, you can reproduce the error with: \n${python} ${script} ${pyArgs.join(" ")}`);
                const error = new Error(resultError);
                console.error(error);
                reject(resultError);
            }
        })
    });
}

const get_path = async(ctx, next) => {
    // const ewd1 = "contactpad circle r 750\nsquare path M0 100 L0 1900 L100 2000 L1900 2000 L2000 1900 L2000 100 L1900 0 L100 0 Z\nreservoir_top_1 path M0 100 L0 3905 L100 4005 L1900 4005 L2000 3905 L2000 2000 L4005 2000 L4005 3905 L4105 4005 L5905 4005 L6005 3905 L6005 100 L5905 0 L100 0 Z\nreservoir_top_2 path M0 100 L0 7905 L100 8005 L5905 8005 L6005 7905 L6005 100 L5905 0 L100 0 Z\nreservoir_left_1 path M0 100 L0 5910 L100 6010 L3905 6010 L4005 5910 L4005 4110 L3905 4010 L2000 4010 L2000 2000 L3905 2000 L4005 1900 L4005 100 L3905 0 L100 0 Z\nreservoir_left_2 path M0 100 L0 5910 L100 6010 L7905 6010 L8005 5910 L8005 100 L7905 0 L100 0 Z\nwastepool path M0 100 L0 9920 L100 10020 L5910 10020 L6010 9920 L6010 100 L5910 0 L100 0 Z\nlongelectrode path M0 100 L0 5910 L100 6010 L1900 6010 L2000 5910 L2000 100 L1900 0 L100 0 Z\nReferenceelectrode path M0 0 L0 10000 L10000 10000 L10000 0 Z\n#ENDOFDEFINITION#\ncontactpad 0 0\ncontactpad 2540 0\ncontactpad 5080 0\ncontactpad 7620 0\ncontactpad 10160 0\ncontactpad 12700 0\ncontactpad 15240 0\ncontactpad 17780 0\ncontactpad 20320 0\ncontactpad 22860 0\ncontactpad 25400 0\ncontactpad 27940 0\ncontactpad 30480 0\ncontactpad 33020 0\ncontactpad 35560 0\ncontactpad 38100 0\ncontactpad 40640 0\ncontactpad 43180 0\ncontactpad 45720 0\ncontactpad 48260 0\ncontactpad 50800 0\ncontactpad 53340 0\ncontactpad 55880 0\ncontactpad 58420 0\ncontactpad 60960 0\ncontactpad 63500 0\ncontactpad 66040 0\ncontactpad 68580 0\ncontactpad 71120 0\ncontactpad 73660 0\ncontactpad 76200 0\ncontactpad 78740 0\ncontactpad 0 2540\ncontactpad 2540 2540\ncontactpad 5080 2540\ncontactpad 7620 2540\ncontactpad 10160 2540\ncontactpad 12700 2540\ncontactpad 15240 2540\ncontactpad 17780 2540\ncontactpad 20320 2540\ncontactpad 22860 2540\ncontactpad 25400 2540\ncontactpad 27940 2540\ncontactpad 30480 2540\ncontactpad 33020 2540\ncontactpad 35560 2540\ncontactpad 38100 2540\ncontactpad 40640 2540\ncontactpad 43180 2540\ncontactpad 45720 2540\ncontactpad 48260 2540\ncontactpad 50800 2540\ncontactpad 53340 2540\ncontactpad 55880 2540\ncontactpad 58420 2540\ncontactpad 60960 2540\ncontactpad 63500 2540\ncontactpad 66040 2540\ncontactpad 68580 2540\ncontactpad 71120 2540\ncontactpad 73660 2540\ncontactpad 76200 2540\ncontactpad 78740 2540\ncontactpad 0 5080\ncontactpad 2540 5080\ncontactpad 5080 5080\ncontactpad 7620 5080\ncontactpad 10160 5080\ncontactpad 12700 5080\ncontactpad 15240 5080\ncontactpad 17780 5080\ncontactpad 20320 5080\ncontactpad 22860 5080\ncontactpad 25400 5080\ncontactpad 27940 5080\ncontactpad 30480 5080\ncontactpad 33020 5080\ncontactpad 35560 5080\ncontactpad 38100 5080\ncontactpad 40640 5080\ncontactpad 43180 5080\ncontactpad 45720 5080\ncontactpad 48260 5080\ncontactpad 50800 5080\ncontactpad 53340 5080\ncontactpad 55880 5080\ncontactpad 58420 5080\ncontactpad 60960 5080\ncontactpad 63500 5080\ncontactpad 66040 5080\ncontactpad 68580 5080\ncontactpad 71120 5080\ncontactpad 73660 5080\ncontactpad 76200 5080\ncontactpad 78740 5080\ncontactpad 0 7620\ncontactpad 2540 7620\ncontactpad 5080 7620\ncontactpad 7620 7620\ncontactpad 10160 7620\ncontactpad 12700 7620\ncontactpad 15240 7620\ncontactpad 17780 7620\ncontactpad 20320 7620\ncontactpad 22860 7620\ncontactpad 25400 7620\ncontactpad 27940 7620\ncontactpad 30480 7620\ncontactpad 33020 7620\ncontactpad 35560 7620\ncontactpad 38100 7620\ncontactpad 40640 7620\ncontactpad 43180 7620\ncontactpad 45720 7620\ncontactpad 48260 7620\ncontactpad 50800 7620\ncontactpad 53340 7620\ncontactpad 55880 7620\ncontactpad 58420 7620\ncontactpad 60960 7620\ncontactpad 63500 7620\ncontactpad 66040 7620\ncontactpad 68580 7620\ncontactpad 71120 7620\ncontactpad 73660 7620\ncontactpad 76200 7620\ncontactpad 78740 7620\ncontactpad 0 56896\ncontactpad 2540 56896\ncontactpad 5080 56896\ncontactpad 7620 56896\ncontactpad 10160 56896\ncontactpad 12700 56896\ncontactpad 15240 56896\ncontactpad 17780 56896\ncontactpad 20320 56896\ncontactpad 22860 56896\ncontactpad 25400 56896\ncontactpad 27940 56896\ncontactpad 30480 56896\ncontactpad 33020 56896\ncontactpad 35560 56896\ncontactpad 38100 56896\ncontactpad 40640 56896\ncontactpad 43180 56896\ncontactpad 45720 56896\ncontactpad 48260 56896\ncontactpad 50800 56896\ncontactpad 53340 56896\ncontactpad 55880 56896\ncontactpad 58420 56896\ncontactpad 60960 56896\ncontactpad 63500 56896\ncontactpad 66040 56896\ncontactpad 68580 56896\ncontactpad 71120 56896\ncontactpad 73660 56896\ncontactpad 76200 56896\ncontactpad 78740 56896\ncontactpad 0 59436\ncontactpad 2540 59436\ncontactpad 5080 59436\ncontactpad 7620 59436\ncontactpad 10160 59436\ncontactpad 12700 59436\ncontactpad 15240 59436\ncontactpad 17780 59436\ncontactpad 20320 59436\ncontactpad 22860 59436\ncontactpad 25400 59436\ncontactpad 27940 59436\ncontactpad 30480 59436\ncontactpad 33020 59436\ncontactpad 35560 59436\ncontactpad 38100 59436\ncontactpad 40640 59436\ncontactpad 43180 59436\ncontactpad 45720 59436\ncontactpad 48260 59436\ncontactpad 50800 59436\ncontactpad 53340 59436\ncontactpad 55880 59436\ncontactpad 58420 59436\ncontactpad 60960 59436\ncontactpad 63500 59436\ncontactpad 66040 59436\ncontactpad 68580 59436\ncontactpad 71120 59436\ncontactpad 73660 59436\ncontactpad 76200 59436\ncontactpad 78740 59436\ncontactpad 0 61976\ncontactpad 2540 61976\ncontactpad 5080 61976\ncontactpad 7620 61976\ncontactpad 10160 61976\ncontactpad 12700 61976\ncontactpad 15240 61976\ncontactpad 17780 61976\ncontactpad 20320 61976\ncontactpad 22860 61976\ncontactpad 25400 61976\ncontactpad 27940 61976\ncontactpad 30480 61976\ncontactpad 33020 61976\ncontactpad 35560 61976\ncontactpad 38100 61976\ncontactpad 40640 61976\ncontactpad 43180 61976\ncontactpad 45720 61976\ncontactpad 48260 61976\ncontactpad 50800 61976\ncontactpad 53340 61976\ncontactpad 55880 61976\ncontactpad 58420 61976\ncontactpad 60960 61976\ncontactpad 63500 61976\ncontactpad 66040 61976\ncontactpad 68580 61976\ncontactpad 71120 61976\ncontactpad 73660 61976\ncontactpad 76200 61976\ncontactpad 78740 61976\ncontactpad 0 64516\ncontactpad 2540 64516\ncontactpad 5080 64516\ncontactpad 7620 64516\ncontactpad 10160 64516\ncontactpad 12700 64516\ncontactpad 15240 64516\ncontactpad 17780 64516\ncontactpad 20320 64516\ncontactpad 22860 64516\ncontactpad 25400 64516\ncontactpad 27940 64516\ncontactpad 30480 64516\ncontactpad 33020 64516\ncontactpad 35560 64516\ncontactpad 38100 64516\ncontactpad 40640 64516\ncontactpad 43180 64516\ncontactpad 45720 64516\ncontactpad 48260 64516\ncontactpad 50800 64516\ncontactpad 53340 64516\ncontactpad 55880 64516\ncontactpad 58420 64516\ncontactpad 60960 64516\ncontactpad 63500 64516\ncontactpad 66040 64516\ncontactpad 68580 64516\ncontactpad 71120 64516\ncontactpad 73660 64516\ncontactpad 76200 64516\ncontactpad 78740 64516\n";
    // const ewd2 = "Referenceelectrode -14835 13689\n#ENDOFLAYOUT#\n0,0,0,0,0,0,0,0;100\n#ENDOFSEQUENCE#";
    // runPy.then(function(fromRunpy) {
    //     console.log(fromRunpy.toString());
    //     ctx.jsonp({ success: fromRunpy.toString() });
    // });

    // var ewd = "" + ewd1;

    const { ewd1, ewd2, ewd3, name } = ctx.request.body;

    // const content = ctx.params.ewd.split('*');
    // for (const i in content) {
    //     if (content[i].length > 5) {
    //         const content2 = content[i].split('~');
    //         for (const j in content2) {
    //             if (content2[j].length > 5) {
    //                 ewd = ewd + content2[j] + ' ';
    //             }
    //         }
    //         ewd = ewd + '\n';
    //     }
    // }
    // ewd = ewd + ewd2;

    var ewd = ewd1 + ewd2 + ewd3;
    console.log(ewd);

    //const ewd = "contactpad circle r 750\nsquare path M0 100 L0 1900 L100 2000 L1900 2000 L2000 1900 L2000 100 L1900 0 L100 0 Z\nreservoir_top_1 path M0 100 L0 3905 L100 4005 L1900 4005 L2000 3905 L2000 2000 L4005 2000 L4005 3905 L4105 4005 L5905 4005 L6005 3905 L6005 100 L5905 0 L100 0 Z\nreservoir_top_2 path M0 100 L0 7905 L100 8005 L5905 8005 L6005 7905 L6005 100 L5905 0 L100 0 Z\nreservoir_left_1 path M0 100 L0 5910 L100 6010 L3905 6010 L4005 5910 L4005 4110 L3905 4010 L2000 4010 L2000 2000 L3905 2000 L4005 1900 L4005 100 L3905 0 L100 0 Z\nreservoir_left_2 path M0 100 L0 5910 L100 6010 L7905 6010 L8005 5910 L8005 100 L7905 0 L100 0 Z\nwastepool path M0 100 L0 9920 L100 10020 L5910 10020 L6010 9920 L6010 100 L5910 0 L100 0 Z\nlongelectrode path M0 100 L0 5910 L100 6010 L1900 6010 L2000 5910 L2000 100 L1900 0 L100 0 Z\nReferenceelectrode path M0 0 L0 10000 L10000 10000 L10000 0 Z\n#ENDOFDEFINITION#\ncontactpad 0 0\ncontactpad 2540 0\ncontactpad 5080 0\ncontactpad 7620 0\ncontactpad 10160 0\ncontactpad 12700 0\ncontactpad 15240 0\ncontactpad 17780 0\ncontactpad 20320 0\ncontactpad 22860 0\ncontactpad 25400 0\ncontactpad 27940 0\ncontactpad 30480 0\ncontactpad 33020 0\ncontactpad 35560 0\ncontactpad 38100 0\ncontactpad 40640 0\ncontactpad 43180 0\ncontactpad 45720 0\ncontactpad 48260 0\ncontactpad 50800 0\ncontactpad 53340 0\ncontactpad 55880 0\ncontactpad 58420 0\ncontactpad 60960 0\ncontactpad 63500 0\ncontactpad 66040 0\ncontactpad 68580 0\ncontactpad 71120 0\ncontactpad 73660 0\ncontactpad 76200 0\ncontactpad 78740 0\ncontactpad 0 2540\ncontactpad 2540 2540\ncontactpad 5080 2540\ncontactpad 7620 2540\ncontactpad 10160 2540\ncontactpad 12700 2540\ncontactpad 15240 2540\ncontactpad 17780 2540\ncontactpad 20320 2540\ncontactpad 22860 2540\ncontactpad 25400 2540\ncontactpad 27940 2540\ncontactpad 30480 2540\ncontactpad 33020 2540\ncontactpad 35560 2540\ncontactpad 38100 2540\ncontactpad 40640 2540\ncontactpad 43180 2540\ncontactpad 45720 2540\ncontactpad 48260 2540\ncontactpad 50800 2540\ncontactpad 53340 2540\ncontactpad 55880 2540\ncontactpad 58420 2540\ncontactpad 60960 2540\ncontactpad 63500 2540\ncontactpad 66040 2540\ncontactpad 68580 2540\ncontactpad 71120 2540\ncontactpad 73660 2540\ncontactpad 76200 2540\ncontactpad 78740 2540\ncontactpad 0 5080\ncontactpad 2540 5080\ncontactpad 5080 5080\ncontactpad 7620 5080\ncontactpad 10160 5080\ncontactpad 12700 5080\ncontactpad 15240 5080\ncontactpad 17780 5080\ncontactpad 20320 5080\ncontactpad 22860 5080\ncontactpad 25400 5080\ncontactpad 27940 5080\ncontactpad 30480 5080\ncontactpad 33020 5080\ncontactpad 35560 5080\ncontactpad 38100 5080\ncontactpad 40640 5080\ncontactpad 43180 5080\ncontactpad 45720 5080\ncontactpad 48260 5080\ncontactpad 50800 5080\ncontactpad 53340 5080\ncontactpad 55880 5080\ncontactpad 58420 5080\ncontactpad 60960 5080\ncontactpad 63500 5080\ncontactpad 66040 5080\ncontactpad 68580 5080\ncontactpad 71120 5080\ncontactpad 73660 5080\ncontactpad 76200 5080\ncontactpad 78740 5080\ncontactpad 0 7620\ncontactpad 2540 7620\ncontactpad 5080 7620\ncontactpad 7620 7620\ncontactpad 10160 7620\ncontactpad 12700 7620\ncontactpad 15240 7620\ncontactpad 17780 7620\ncontactpad 20320 7620\ncontactpad 22860 7620\ncontactpad 25400 7620\ncontactpad 27940 7620\ncontactpad 30480 7620\ncontactpad 33020 7620\ncontactpad 35560 7620\ncontactpad 38100 7620\ncontactpad 40640 7620\ncontactpad 43180 7620\ncontactpad 45720 7620\ncontactpad 48260 7620\ncontactpad 50800 7620\ncontactpad 53340 7620\ncontactpad 55880 7620\ncontactpad 58420 7620\ncontactpad 60960 7620\ncontactpad 63500 7620\ncontactpad 66040 7620\ncontactpad 68580 7620\ncontactpad 71120 7620\ncontactpad 73660 7620\ncontactpad 76200 7620\ncontactpad 78740 7620\ncontactpad 0 56896\ncontactpad 2540 56896\ncontactpad 5080 56896\ncontactpad 7620 56896\ncontactpad 10160 56896\ncontactpad 12700 56896\ncontactpad 15240 56896\ncontactpad 17780 56896\ncontactpad 20320 56896\ncontactpad 22860 56896\ncontactpad 25400 56896\ncontactpad 27940 56896\ncontactpad 30480 56896\ncontactpad 33020 56896\ncontactpad 35560 56896\ncontactpad 38100 56896\ncontactpad 40640 56896\ncontactpad 43180 56896\ncontactpad 45720 56896\ncontactpad 48260 56896\ncontactpad 50800 56896\ncontactpad 53340 56896\ncontactpad 55880 56896\ncontactpad 58420 56896\ncontactpad 60960 56896\ncontactpad 63500 56896\ncontactpad 66040 56896\ncontactpad 68580 56896\ncontactpad 71120 56896\ncontactpad 73660 56896\ncontactpad 76200 56896\ncontactpad 78740 56896\ncontactpad 0 59436\ncontactpad 2540 59436\ncontactpad 5080 59436\ncontactpad 7620 59436\ncontactpad 10160 59436\ncontactpad 12700 59436\ncontactpad 15240 59436\ncontactpad 17780 59436\ncontactpad 20320 59436\ncontactpad 22860 59436\ncontactpad 25400 59436\ncontactpad 27940 59436\ncontactpad 30480 59436\ncontactpad 33020 59436\ncontactpad 35560 59436\ncontactpad 38100 59436\ncontactpad 40640 59436\ncontactpad 43180 59436\ncontactpad 45720 59436\ncontactpad 48260 59436\ncontactpad 50800 59436\ncontactpad 53340 59436\ncontactpad 55880 59436\ncontactpad 58420 59436\ncontactpad 60960 59436\ncontactpad 63500 59436\ncontactpad 66040 59436\ncontactpad 68580 59436\ncontactpad 71120 59436\ncontactpad 73660 59436\ncontactpad 76200 59436\ncontactpad 78740 59436\ncontactpad 0 61976\ncontactpad 2540 61976\ncontactpad 5080 61976\ncontactpad 7620 61976\ncontactpad 10160 61976\ncontactpad 12700 61976\ncontactpad 15240 61976\ncontactpad 17780 61976\ncontactpad 20320 61976\ncontactpad 22860 61976\ncontactpad 25400 61976\ncontactpad 27940 61976\ncontactpad 30480 61976\ncontactpad 33020 61976\ncontactpad 35560 61976\ncontactpad 38100 61976\ncontactpad 40640 61976\ncontactpad 43180 61976\ncontactpad 45720 61976\ncontactpad 48260 61976\ncontactpad 50800 61976\ncontactpad 53340 61976\ncontactpad 55880 61976\ncontactpad 58420 61976\ncontactpad 60960 61976\ncontactpad 63500 61976\ncontactpad 66040 61976\ncontactpad 68580 61976\ncontactpad 71120 61976\ncontactpad 73660 61976\ncontactpad 76200 61976\ncontactpad 78740 61976\ncontactpad 0 64516\ncontactpad 2540 64516\ncontactpad 5080 64516\ncontactpad 7620 64516\ncontactpad 10160 64516\ncontactpad 12700 64516\ncontactpad 15240 64516\ncontactpad 17780 64516\ncontactpad 20320 64516\ncontactpad 22860 64516\ncontactpad 25400 64516\ncontactpad 27940 64516\ncontactpad 30480 64516\ncontactpad 33020 64516\ncontactpad 35560 64516\ncontactpad 38100 64516\ncontactpad 40640 64516\ncontactpad 43180 64516\ncontactpad 45720 64516\ncontactpad 48260 64516\ncontactpad 50800 64516\ncontactpad 53340 64516\ncontactpad 55880 64516\ncontactpad 58420 64516\ncontactpad 60960 64516\ncontactpad 63500 64516\ncontactpad 66040 64516\ncontactpad 68580 64516\ncontactpad 71120 64516\ncontactpad 73660 64516\ncontactpad 76200 64516\ncontactpad 78740 64516\nsquare -2529.365569712403 12109.634430287597 \nsquare -2529.365569712403 49803.63290059399 \nReferenceelectrode -14835 13689\n#ENDOFLAYOUT#\n0,0,0,0,0,0,0,0;100\n#ENDOFSEQUENCE#";

    //const result = "";
    const result = await callPython("CAD_T3.py", ewd, name);
    ctx.body = result;

    //ctx.jsonp({ data: ewd })
}


module.exports = {
    get_path
}